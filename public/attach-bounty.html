<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Attach Bounty - BountyPay</title>
  <script src="https://cdn.jsdelivr.net/npm/thirdweb@5/dist/thirdweb.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 500px;
      width: 100%;
      padding: 40px;
    }

    h1 {
      font-size: 28px;
      margin-bottom: 10px;
      color: #1a202c;
    }

    .subtitle {
      color: #718096;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .info-box {
      background: #f7fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .info-box p {
      margin: 5px 0;
      font-size: 14px;
      color: #4a5568;
    }

    .info-box strong {
      color: #2d3748;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2d3748;
      font-size: 14px;
    }

    input, select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 16px;
      margin-bottom: 20px;
      transition: border-color 0.2s;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .status {
      margin-top: 20px;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      display: none;
    }

    .status.success {
      background: #c6f6d5;
      color: #22543d;
      border: 1px solid #9ae6b4;
    }

    .status.error {
      background: #fed7d7;
      color: #742a2a;
      border: 1px solid #fc8181;
    }

    .status.loading {
      background: #bee3f8;
      color: #2c5282;
      border: 1px solid #90cdf4;
    }

    .wallet-info {
      background: #fefcbf;
      border: 1px solid #f6e05e;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 20px;
      font-size: 13px;
      color: #744210;
    }

    a {
      color: #667eea;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ’° Attach Bounty</h1>
    <p class="subtitle">Fund this issue with USDC on Base</p>

    <div class="info-box" id="issueInfo">
      <p><strong>Repository:</strong> <span id="repoName">Loading...</span></p>
      <p><strong>Issue:</strong> #<span id="issueNumber">-</span></p>
      <p><strong>Link:</strong> <a id="issueLink" href="#" target="_blank">View on GitHub</a></p>
    </div>

    <div id="walletSection">
      <button class="btn btn-primary" id="connectWallet">Connect Wallet</button>
      
      <div class="wallet-info" id="walletInfo" style="display: none;">
        <strong>Connected:</strong> <span id="walletAddress"></span>
      </div>
    </div>

    <div id="bountyForm" style="display: none;">
      <div>
        <label for="amount">Bounty Amount (USDC)</label>
        <input type="number" id="amount" placeholder="500" min="1" step="0.01">
      </div>

      <div>
        <label for="deadline">Deadline</label>
        <input type="date" id="deadline">
      </div>

      <button class="btn btn-primary" id="fundButton">Fund Bounty</button>
    </div>

    <div class="status" id="status"></div>
  </div>

  <script type="module">
    import { ethers } from 'https://cdn.jsdelivr.net/npm/ethers@6.9.0/+esm';

    const ESCROW_ADDRESS = '0xb30283b5412B89d8B8dE3C6614aE2754a4545aFD';
    const USDC_ADDRESS = '0x036CbD53842c5426634e7929541eC2318f3dCF7e';
    const CHAIN_ID = 84532; // Base Sepolia
    const CHAIN_NAME = 'Base Sepolia';
    const RPC_URL = 'https://sepolia.base.org';

    const ESCROW_ABI = [
      'function createBounty(address resolver, bytes32 repoIdHash, uint64 issueNumber, uint64 deadline, uint256 amount) external returns (bytes32)',
    ];

    const ERC20_ABI = [
      'function approve(address spender, uint256 amount) external returns (bool)',
      'function allowance(address owner, address spender) external view returns (uint256)'
    ];

    let provider, signer, walletAddress;
    
    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const repoFullName = urlParams.get('repo');
    const issueNumber = urlParams.get('issue');
    const repoId = urlParams.get('repoId');
    const installationId = urlParams.get('installationId');
    const presetAmount = urlParams.get('amount');

    console.log('URL Params:', { repoFullName, issueNumber, repoId, installationId });

    // Display issue info immediately
    if (repoFullName && issueNumber) {
      document.getElementById('repoName').textContent = repoFullName;
      document.getElementById('issueNumber').textContent = issueNumber;
      document.getElementById('issueLink').href = `https://github.com/${repoFullName}/issues/${issueNumber}`;
      if (presetAmount) {
        document.getElementById('amount').value = presetAmount;
      }
    } else {
      document.getElementById('repoName').textContent = 'Error: Missing parameters';
      document.getElementById('issueNumber').textContent = '?';
      showStatus('Missing required URL parameters', 'error');
    }

    // Connect wallet using browser's Web3 provider
    document.getElementById('connectWallet').addEventListener('click', async () => {
      try {
        showStatus('Connecting wallet...', 'loading');

        // Check if Web3 provider exists (MetaMask, Coinbase Wallet, etc.)
        if (!window.ethereum) {
          showStatus('Please install MetaMask or another Web3 wallet', 'error');
          window.open('https://metamask.io/download/', '_blank');
          return;
        }

        // Request account access
        provider = new ethers.BrowserProvider(window.ethereum);
        const accounts = await provider.send('eth_requestAccounts', []);
        walletAddress = accounts[0];

        console.log('Wallet connected:', walletAddress);

        // Check and switch network if needed
        const network = await provider.getNetwork();
        console.log('Current network:', network.chainId);

        if (Number(network.chainId) !== CHAIN_ID) {
          showStatus('Switching to Base Sepolia...', 'loading');
          try {
            await window.ethereum.request({
              method: 'wallet_switchEthereumChain',
              params: [{ chainId: `0x${CHAIN_ID.toString(16)}` }],
            });
          } catch (switchError) {
            // Chain not added, try to add it
            if (switchError.code === 4902) {
              await window.ethereum.request({
                method: 'wallet_addEthereumChain',
                params: [{
                  chainId: `0x${CHAIN_ID.toString(16)}`,
                  chainName: CHAIN_NAME,
                  nativeCurrency: {
                    name: 'ETH',
                    symbol: 'ETH',
                    decimals: 18
                  },
                  rpcUrls: [RPC_URL],
                  blockExplorerUrls: ['https://sepolia.basescan.org']
                }],
              });
            } else {
              throw switchError;
            }
          }
          // Reconnect after network switch
          provider = new ethers.BrowserProvider(window.ethereum);
        }

        signer = await provider.getSigner();

        // Show wallet info and bounty form
        document.getElementById('walletAddress').textContent = 
          walletAddress.slice(0, 6) + '...' + walletAddress.slice(-4);
        document.getElementById('walletInfo').style.display = 'block';
        document.getElementById('connectWallet').style.display = 'none';
        document.getElementById('bountyForm').style.display = 'block';
        showStatus('Wallet connected!', 'success');

        // Set default deadline (7 days from now)
        const defaultDeadline = new Date();
        defaultDeadline.setDate(defaultDeadline.getDate() + 7);
        document.getElementById('deadline').valueAsDate = defaultDeadline;

      } catch (error) {
        console.error('Wallet connection error:', error);
        showStatus(error.message || 'Failed to connect wallet', 'error');
      }
    });

    // Fund bounty
    document.getElementById('fundButton').addEventListener('click', async () => {
      try {
        if (!repoFullName || !issueNumber || !repoId) {
          throw new Error('Missing required parameters. Please use the link from GitHub.');
        }

        const amount = document.getElementById('amount').value;
        const deadline = document.getElementById('deadline').value;

        if (!amount || parseFloat(amount) <= 0) {
          throw new Error('Please enter a valid amount');
        }

        if (!deadline) {
          throw new Error('Please select a deadline');
        }

        const deadlineTimestamp = Math.floor(new Date(deadline).getTime() / 1000);
        const amountWei = ethers.parseUnits(amount, 6);

        console.log('Creating bounty:', {
          amount,
          deadline: deadlineTimestamp,
          repoId,
          issueNumber
        });

        showStatus('Approving USDC...', 'loading');

        // Approve USDC
        const usdc = new ethers.Contract(USDC_ADDRESS, ERC20_ABI, signer);
        const approveTx = await usdc.approve(ESCROW_ADDRESS, amountWei);
        console.log('Approval tx:', approveTx.hash);
        await approveTx.wait();

        showStatus('Creating bounty on-chain...', 'loading');

        // Create bounty
        const escrow = new ethers.Contract(ESCROW_ADDRESS, ESCROW_ABI, signer);
        
        // Create repoIdHash (simple method: pad repo ID to bytes32)
        const repoIdHash = '0x' + parseInt(repoId).toString(16).padStart(64, '0');
        
        const tx = await escrow.createBounty(
          walletAddress, // resolver (sponsor acts as resolver initially)
          repoIdHash,
          parseInt(issueNumber),
          deadlineTimestamp,
          amountWei
        );

        console.log('Bounty creation tx:', tx.hash);
        const receipt = await tx.wait();
        
        showStatus('Recording bounty in database...', 'loading');

        // Record in database
        const response = await fetch('/api/bounty/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            repoFullName,
            repoId: parseInt(repoId),
            issueNumber: parseInt(issueNumber),
            sponsorAddress: walletAddress,
            amount: amountWei.toString(),
            deadline: deadlineTimestamp,
            txHash: receipt.hash,
            installationId: parseInt(installationId) || 0
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to record bounty');
        }

        showStatus(`âœ… Bounty created! Redirecting...`, 'success');
        
        // Redirect back to GitHub issue after 2 seconds
        setTimeout(() => {
          window.open(`https://github.com/${repoFullName}/issues/${issueNumber}`, '_self');
        }, 2000);

      } catch (error) {
        console.error('Bounty creation error:', error);
        showStatus(error.message || 'Failed to create bounty', 'error');
      }
    });

    function showStatus(message, type) {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = `status ${type}`;
      status.style.display = 'block';
      
      if (type === 'success' || type === 'error') {
        setTimeout(() => {
          if (type === 'error') status.style.display = 'none';
        }, 5000);
      }
    }
  </script>
</body>
</html>
